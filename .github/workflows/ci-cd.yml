name: CI/CD

on:
  push:
    branches: [main, master]

jobs:
  # -------------------------------
  # Job 1: Build and push Docker image
  # -------------------------------
  build:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.set-tag.outputs.image-tag }}
    steps:
      # Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # Enable Qemu for multi-arch builds
      - name: Set up Qemu
        uses: docker/setup-buildx-action@v2

      # Docker Hub login
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Set image tag
      - name: Set image tag
        id: set-tag
        run: echo "image-tag=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      # Build & push backend image
      - name: Build & push backend image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/backend:${{ steps.set-tag.outputs.image-tag }}
            ${{ secrets.DOCKER_USERNAME }}/backend:latest

  # -------------------------------
  # Job 2: Kubernetes deploy
  # -------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ secrets.KUBE_CONFIG != '' }}
    steps:
      # Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # Set up kubectl
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      # Configure kubeconfig
      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          if echo "${{ secrets.KUBE_CONFIG }}" | grep -q "apiVersion:"; then
            echo "${{ secrets.KUBE_CONFIG }}" > $HOME/.kube/config
          else
            echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          fi
          chmod 600 $HOME/.kube/config
          echo "Kubeconfig configured successfully"

      # Fix kubeconfig server URL if needed
      - name: Fix kubeconfig API server URL
        env:
          REAL_API_SERVER: ${{ secrets.KUBE_API_SERVER }}
        run: |
          CONFIG_PATH="$HOME/.kube/config"
          if [ -n "$REAL_API_SERVER" ]; then
            sed -i "s|server: http://localhost:8080|server: $REAL_API_SERVER|g" $CONFIG_PATH
            echo "Applied KUBE_API_SERVER override: $REAL_API_SERVER"
          fi

      # Test Kubernetes connection
      - name: Test Kubernetes connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      # Deploy manifests & update image
      - name: Deploy backend
        run: |
          IMAGE=${{ secrets.DOCKER_USERNAME }}/backend:${{ needs.build.outputs.image-tag }}
          kubectl -n myapp set image deployment/backend backend=$IMAGE --record
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/secret.yaml
          kubectl apply -f k8s/mysql-pvc.yaml
          kubectl apply -f k8s/mysql-deployment.yaml
          kubectl apply -f k8s/backend-deployment.yaml
          kubectl apply -f k8s/ingress.yaml

      # Wait for backend pod
      - name: Wait for backend rollout
        run: |
          kubectl -n myapp rollout status deployment/backend --timeout=120s
